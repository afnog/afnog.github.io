<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
     "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<!--
	PLEASE DO NOT EDIT THIS HTML BY HAND. It is auto-generated. See
	http://afnog.github.io/sse/#meta-about-this-site for details.
-->
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta charset="UTF-8" />
	<link rel="stylesheet" href="../../../workshop.css" type="text/css" />
	<link rel="stylesheet" href="../../css/sse.css" type="text/css" />
	<link rel="copyright" title="Copyright and Usage Restrictions"
		href="../00readme.html" type="text/html" />
	<link rel="home" title="AfNOG Workshop web site"
		href="http://www.ws.afnog.org/" type="text/html" />
	<link rel="up" title="AfNOG 2017 Workshop Main Page"
		href="../index.html" type="text/html" />
	<title>SS-E - AfNOG 2017 Workshop</title>
	<!-- https://developers.google.com/web/fundamentals/getting-started/your-first-multi-screen-site/responsive?hl=en -->
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--
	Showdown - Markdown in Javascript
	from http://www.showdown.im/
	-->
	<script type="text/javascript" src="../../js/showdown.js"></script>
	<style type="text/javascript">
	pre {
		font-size: 120%;
	}
	</style>
</head>
<body>

<!--
	PLEASE DO NOT EDIT THIS HTML BY HAND. It is auto-generated. See
	http://afnog.github.io/sse/#meta-about-this-site for details.
-->

<div class="arrowlinks">
  <a href="http://www.afnog.org/">AfNOG</a>
  &gt;
  <a href="http://www.ws.afnog.org/">Workshops</a>
  &gt;
  <a href="../../../index.html">2017</a>
  &gt;
  <a href="../../">Track SS-E &mdash; Scalable Internet Services</a>
</div>

<hr>

<h1 id="server-setup-for-afnog-ss-e-virtualisation">Server setup for AfNOG SS-E virtualisation</h1>

<p>Install Ubuntu Desktop (not Server) 16.04 AMD64, then:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt install vim
</code></pre>
</div>

<p>Create <code class="highlighter-rouge">/etc/network/iptables</code> with the following contents:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># Generated by iptables-save v1.6.0 on Fri May 27 17:09:25 2016
*filter
:INPUT DROP [3:152]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [256:31110]
-A INPUT -m state --state ESTABLISHED -j ACCEPT
-A INPUT -i lo -p udp -m udp --dport 53 -m comment --comment "Allow local dnsmasq" -j ACCEPT
-A INPUT -i br0 -p tcp -m tcp --dport 53 -j ACCEPT
-A INPUT -i br0 -p udp -m udp --dport 53 -j ACCEPT
-A INPUT -i br0 -p tcp -m tcp --dport 67 -j ACCEPT
-A INPUT -i br0 -p udp -m udp --dport 67 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
-A INPUT -s 196.200.208.0/20 -p tcp -m tcp --dport 80 -j ACCEPT -m comment --comment "Apache"
-A INPUT -s 196.200.208.0/20 -p tcp -m tcp --dport 3142 -j ACCEPT -m comment --comment "apt-cacher-ng"
-A INPUT -s 196.200.208.0/20 -p tcp -m tcp --dport 3141 -j ACCEPT -m comment --comment "devpi-server"
-A INPUT -d 255.255.255.255/32 -m comment --comment "Drop multicast without logging" -j DROP
-A INPUT -m limit --limit 5/min -j LOG --log-prefix "Rejected INPUT: "
-A FORWARD -o br0 -j ACCEPT
-A FORWARD -i br0 -j ACCEPT
COMMIT
*nat
-A POSTROUTING -s 196.200.219.0/24 -j MASQUERADE
COMMIT
*mangle
-A POSTROUTING -p udp --dport bootpc -j CHECKSUM --checksum-fill
COMMIT
# Completed on Fri May 27 17:09:25 2016
</code></pre>
</div>

<p>Add the following lines to <code class="highlighter-rouge">/etc/rc.local</code> before the line <code class="highlighter-rouge">exit 0</code>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>echo cfq &gt; /sys/block/sda/queue/scheduler
# Mac Mini only: power on automatically after a power failure
setpci -s 0:1f.0 0xa4.w=0:1
/sbin/iptables-restore /etc/network/iptables
</code></pre>
</div>

<p>And execute <code class="highlighter-rouge">/etc/rc.local</code>.</p>

<p>Setup a local APT cache:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt install apt-cacher-ng
</code></pre>
</div>

<p>Following https://help.ubuntu.com/lts/serverguide/lxc.html, but modified for VLAN bridging:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt install bridge-utils vlan
</code></pre>
</div>

<p>Edit <code class="highlighter-rouge">/etc/network/interfaces</code> and make it look like this, to enable bridging for LXC containers:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># https://help.ubuntu.com/lts/serverguide/network-configuration.html#bridging

auto lo
iface lo inet loopback

auto enp1s0f0
iface enp1s0f0 inet static
	# Please check the following values are appropriate for your network:
	address 196.200.223.144
	netmask 255.255.255.0
	gateway 196.200.223.1

auto br0
iface br0 inet static
	# Please check the following values are appropriate for your network:
	address 196.200.219.2
	netmask 255.255.255.0
	bridge_ports enp1s0f0.219
	bridge_fd 0
	bridge_hello 2
	bridge_maxage 12
	bridge_stp off

auto enp1s0f0.219
iface enp1s0f0.219 inet static
	address 0.0.0.0
	vlan-raw-device enp1s0f0
</code></pre>
</div>

<p>Then bring the interface down and up again:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo ifdown enp1s0f0
sudo ifup br0
</code></pre>
</div>

<p>Check that you can access the Internet, and then reboot the box and check that it comes up OK.</p>

<p>Enable IP forwarding, but only if you expect the server to be used as a router
for the virtual machines or containers, e.g. if they will need to be NATted to
access the Internet during setup week.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>echo net.ipv4.ip_forward=1 | sudo tee -a /etc/sysctl.conf
sudo sysctl -p /etc/sysctl.conf
</code></pre>
</div>

<p>To stop NetworkManager from editing /etc/resolv.conf, edit <code class="highlighter-rouge">/etc/NetworkManager/NetworkManager.conf</code>
and set <code class="highlighter-rouge">dns=none</code>, and restart it. Then edit <code class="highlighter-rouge">/var/run/resolvconf/interface/custom</code> and
add your own DNS settings, and run <code class="highlighter-rouge">resolvconf -u</code> to install them.</p>

<p>Setup a PIP caching server for Ganeti web manager installation:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt install virtualenv
virtualenv devpi
devpi/bin/pip install devpi-server
nohup devpi/bin/devpi-server --host 0.0.0.0 &amp;
</code></pre>
</div>



<script type="text/javascript">
var converter = new Showdown.converter();
var markdownArea = document.getElementById('markdown');
if (markdownArea)
{
	markdownArea.innerHTML = converter.makeHtml(markdownArea.innerHTML);
}
</script>

<div class="bottomlinks">
<p><a href="https://github.com/afnog/sse/blob/master/setup/server/index.md">Edit this page on GitHub</a></p>
<p><a href="../index.html">Return to AfNOG Workshop Main Page</a></p>
</div>

</body>
</html>

