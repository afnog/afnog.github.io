<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
     "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<!--
	PLEASE DO NOT EDIT THIS HTML BY HAND. It is auto-generated. See
	http://afnog.github.io/sse/#meta-about-this-site for details.
-->
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta charset="UTF-8" />
	<link rel="stylesheet" href="../../../workshop.css" type="text/css" />
	<link rel="stylesheet" href="../../css/sse.css" type="text/css" />
	<link rel="copyright" title="Copyright and Usage Restrictions"
		href="../00readme.html" type="text/html" />
	<link rel="home" title="AfNOG Workshop web site"
		href="http://www.ws.afnog.org/" type="text/html" />
	<link rel="up" title="AfNOG 2016 Workshop Main Page"
		href="../index.html" type="text/html" />
	<title>SS-E - AfNOG 2016 Workshop</title>
	<!--
	Showdown - Markdown in Javascript
	from http://www.showdown.im/
	-->
	<script type="text/javascript" src="../../js/showdown.js"></script>
	<style type="text/javascript">
	pre {
		font-size: 120%;
	}
	</style>
</head>
<body>

<!--
	PLEASE DO NOT EDIT THIS HTML BY HAND. It is auto-generated. See
	http://afnog.github.io/sse/#meta-about-this-site for details.
-->

<div class="arrowlinks">
  <a href="http://www.afnog.org/">AfNOG</a>
  &gt;
  <a href="http://www.ws.afnog.org/">Workshops</a>
  &gt;
  <a href="../../../index.html">2016</a>
  &gt;
  <a href="../../">Track SS-E &mdash; Scalable Internet Services</a>
</div>

<hr>

<h1 id="vm-setup-using-lxc">VM setup using LXC</h1>

<p>Using Ubuntu 16.04. Follow <a href="../server/index.html">server setup</a> first to configure the server.</p>

<p>Following https://help.ubuntu.com/lts/serverguide/lxc.html, but modified for VLAN bridging:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>sudo apt install lxc

mkdir -p ~/.config/lxc
LXC_DEFAULTS=~/.config/lxc/default.conf
echo "lxc.id_map = u 0 100000 65536" &gt; $LXC_DEFAULTS
echo "lxc.id_map = g 0 100000 65536" &gt;&gt; $LXC_DEFAULTS
echo "lxc.network.type = veth" &gt;&gt; $LXC_DEFAULTS
echo "lxc.network.link = br0" &gt;&gt; $LXC_DEFAULTS
echo "lxc.start.auto = 1" &gt;&gt; $LXC_DEFAULTS
# Limit RAM used by containers:
echo 'lxc.cgroup.memory.limit_in_bytes = 512M' &gt;&gt; $LXC_DEFAULTS
echo 'lxc.cgroup.memory.memsw.limit_in_bytes = 1G' &gt;&gt; $LXC_DEFAULTS

# Allow up to 60 unprivileged users to use br0 as a veth (bridged network) device:
echo "$USER veth br0 60" | sudo tee -a /etc/lxc/lxc-usernet
</code></pre>
</div>

<p>Edit <code class="highlighter-rouge">/etc/default/grub</code> and set:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>GRUB_CMDLINE_LINUX_DEFAULT="cgroup_enable=memory swapaccount=1"
</code></pre>
</div>

<p>as seen <a href="https://github.com/docker/docker/issues/4250#issuecomment-35566530">here</a>, 
otherwise the <code class="highlighter-rouge">lxc.cgroup.memory.memsw.limit_in_bytes</code> setting will not work, and will prevent
you from starting any LXC containers.</p>

<p>For this to work, you also need to edit <code class="highlighter-rouge">/etc/pam.d/common-session*, find the lines for
</code>pam_cgso.so<code class="highlighter-rouge"> and add </code>,devices` to the end, as described
<a href="http://comments.gmane.org/gmane.linux.kernel.containers.lxc.general/11395">here</a>, like this:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>session optional        pam_cgfs.so -c freezer,memory,name=systemd,devices
</code></pre>
</div>

<p>Then <code class="highlighter-rouge">sudo update-grub</code> and <code class="highlighter-rouge">sudo reboot</code> to activate swap accounting.</p>

<p>Create a gold master guest image:</p>

<div class="highlighter-rouge"><pre class="highlight"><code># lxc-create --template debian --name debian8
lxc-create -t download -n debian8 -- --dist debian --release jessie --arch i386
lxc-ls --fancy
chmod a+x .local
chmod a+x .local/share
lxc-start --name debian8
lxc-attach --name debian8
</code></pre>
</div>

<p>Follow <a href="../guest/index.html">guest setup</a> to configure the gold master guest.</p>

<p>Edit your userâ€™s crontab and add the following line to make your containers auto-start:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>@reboot lxc-autostart
</code></pre>
</div>

<p>Ensure that systemd gives <a href="http://unix.stackexchange.com/questions/253903/creating-threads-fails-with-resource-temporarily-unavailable-with-4-3-kernel">sufficient tasks</a>
to LXC containers started by <code class="highlighter-rouge">at</code> and <code class="highlighter-rouge">cron</code>, by editing <code class="highlighter-rouge">/etc/systemd/system.conf</code>,
uncommenting <code class="highlighter-rouge">DefaultTasksMax</code> and setting it to at least 12288.
See <a href="https://news.ycombinator.com/item?id=11675133">here</a> for more information on this problem.</p>

<p>The following commands are useful for dealing with <code class="highlighter-rouge">systemd</code> and control groups:</p>

<ul>
  <li><code class="highlighter-rouge">systemd-cgls</code></li>
  <li><code class="highlighter-rouge">systemd-cgtop</code></li>
  <li><code class="highlighter-rouge">systemctl status</code></li>
  <li><code class="highlighter-rouge">systemctl show</code></li>
  <li><code class="highlighter-rouge">/sys/fs/cgroup/memory/user/inst/*/lxc</code></li>
</ul>

<p>You may also have issues logging into <code class="highlighter-rouge">sshd</code> with password authentication due to 
<a href="https://github.com/lxc/lxc/issues/661#issuecomment-222444916">this issue</a>. The solution
is to edit <code class="highlighter-rouge">/etc/pam.d/sshd</code> and <code class="highlighter-rouge">/etc/pam.d/cron</code> in the guest, find the line that says:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>session    required     pam_loginuid.so
</code></pre>
</div>

<p>and change it to:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>session    optional     pam_loginuid.so
</code></pre>
</div>

<p>Stop the container and make a lot of copies:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>lxc-stop --name debian8 -t 30
NUM_PCS=40
LXC_ROOT=/home/inst/.local/share/lxc
for i in `seq 1 $NUM_PCS`; do
	hostname=pc$pc
	domainname=$hostname.sse.ws.afnog.org
	lxc-copy --name debian8 --newname $hostname
	macaddr=`openssl rand -hex 4 | sed -e 's/^\(..\)\(..\)\(..\)\(..\).*/52:56:\1:\2:\3:\4/'`
	echo "lxc.network.hwaddr = $macaddr" &gt;&gt; $LXC_ROOT/pc$i.sse.ws.afnog.org/config
done
lxc-autostart
</code></pre>
</div>

<p>Optional: time how long it takes for them all to start completely (enough to get an IP address):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>lxc-autostart -k -t 5
lxc-autostart &amp; time while lxc-ls --fancy | awk '{ print $5 }' | grep -q -- -; do sleep 1; done
</code></pre>
</div>

<p>And try to reduce it with unionfs mounts (experimental):</p>

<div class="highlighter-rouge"><pre class="highlight"><code>lxc-autostart -k -t 5
LXC_ROOT=/home/inst/.local/share/lxc
for i in `seq 1 $NUM_PCS`; do
	hostname=pc$pc
	domainname=$hostname.sse.ws.afnog.org
	sudo umount $LXC_ROOT/$hostname/rootfs
	test -d $LXC_ROOT/$hostname/rootfs.orig || mv $LXC_ROOT/$hostname/rootfs{,.orig}
	mkdir -p $LXC_ROOT/$hostname/rootfs{,.rw}

	echo "none $LXC_ROOT/$hostname/rootfs" \
		"aufs br=$LXC_ROOT/$hostname/rootfs.rw=rw:$LXC_ROOT/debian8/rootfs=ro 0 0" \
	| sudo tee -a /etc/fstab

	sudo mount $LXC_ROOT/$hostname/rootfs
	sudo sed -i -e "s/100/$[100+$i]/" $LXC_ROOT/$hostname/rootfs/etc/network/interfaces
	echo $domainname | sudo tee $LXC_ROOT/$hostname/rootfs/etc/hostname

	# Dovecot has problems locking the mailbox when hosted on AUFS. Work around it
	# by mounting a ramdisk for /var/mail in all containers:
	echo 'none /var/mail tmpfs defaults 0 0' | sudo tee -a $LXC_ROOT/$hostname/rootfs/etc/fstab
	lxc-start -n $hostname
done
lxc-autostart
</code></pre>
</div>


<script type="text/javascript">
var converter = new Showdown.converter();
var markdownArea = document.getElementById('markdown');
if (markdownArea)
{
	markdownArea.innerHTML = converter.makeHtml(markdownArea.innerHTML);
}
</script>

<div class="bottomlinks">
<p><a href="https://github.com/afnog/sse/blob/master/setup/lxc/index.md">Edit this page on GitHub</a></p>
<p><a href="../index.html">Return to AfNOG Workshop Main Page</a></p>
</div>

</body>
</html>

