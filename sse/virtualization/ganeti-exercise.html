<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
     "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta charset="UTF-8" />
	<link rel="stylesheet" href="../workshop.css" type="text/css" />
	<link rel="stylesheet" href="../css/sse.css" type="text/css" />
	<link rel="copyright" title="Copyright and Usage Restrictions"
		href="../00readme.html" type="text/html" />
	<link rel="home" title="AfNOG Workshop web site"
		href="http://www.ws.afnog.org/" type="text/html" />
	<link rel="up" title="AfNOG 2015 Workshop Main Page"
		href="../index.html" type="text/html" />
	<title>SS-E - AfNOG 2015 Workshop</title>
	<!--
	Showdown - Markdown in Javascript
	from http://www.showdown.im/
	-->
	<script type="text/javascript" src="../js/showdown.js"></script>
	<style>
	pre {
		font-size: 120%;
	}
	</style>
</head>
<body>

<div class="arrowlinks">
  <a href="http://www.afnog.org/">AfNOG</a>
  &gt;
  <a href="http://www.ws.afnog.org/">Workshops</a>
  &gt;
  <a href="../../index.html">2015</a>
  &gt;
  <a href="../">Track SS-E &mdash; Scalable Internet Services</a>
</div>

<hr>

<h1 id="ganeti-exercise">Ganeti Exercise</h1>

<p><a href="https://code.google.com/p/ganeti/">Ganeti</a> is a virtual machine cluster
management tool developed by Google. The solution stack uses either Xen or KVM
as the virtualization platform, LVM for disk management, and optionally DRBD
for disk replication across physical hosts.</p>

<p>We will install Ganeti in a virtual machine, configure it to use the Xen
hypervisor, and use it to create and manage some virtual machines.</p>

<p>Normally you would install this on your physical hosts. We are using it in a
VirtualBox virtual machine which is pretending to be our physical host, because
we don’t have enough physical boxes for everyone. This forces us to use Xen
(which is slower than KVM) because we can’t use KVM inside a VirtualBox virtual
machine. You could use either for a real deployment. The installation process
is slightly different. KVM is not covered here.</p>

<h2 id="installing-the-first-host-machine">Installing the first host machine</h2>

<p>Install VirtualBox or make sure you are running version 4.3 or higher.</p>

<p>Open VirtualBox Preferences &gt; Network &gt; Host-Only Adaptors. Ensure that you
have at least two listed: vboxnet0 and vboxnet1. If not, click on the Add
button to the right of the list to create them.</p>

<p>Double-click on <em>vboxnet0</em> and check that the IP addresses are as follows:</p>

<ul>
  <li>IP address: 192.168.56.1</li>
  <li>Subnet mask: 255.255.255.0</li>
</ul>

<p>And check that the DHCP server is enabled and configured for:</p>

<ul>
  <li>Server address: 192.168.56.1</li>
  <li>Server mask: 255.255.255.0</li>
  <li>Lower address bound: 192.168.56.100</li>
  <li>Upper address bound: 192.168.56.200</li>
</ul>

<p><img src="virtualbox-disable-host-network-dhcp.png" alt="Enabling the DHCP server" /></p>

<p>If you have made any changes, then <strong>exit and restart VirtualBox</strong>, otherwise
this change will not take effect, as we discovered after an hour of debugging!</p>

<p>Create a new VM called Ganeti Demo. Give it 2 GB RAM and a 40 GB VDI disk,
dynamically sized.</p>

<h3 id="starting-installation">Starting Installation</h3>

<p>Start the VM and attach the Ubuntu 14.04 Server 64-bit CD. Read the following sections
<strong>before</strong> you start the installation, and use them at the appropriate times during the
installation.</p>

<h3 id="hostname">Hostname</h3>

<p>You must use a fully qualified hostname, for example <code>ganeti.pcXX.sse.ws.afnog.org</code>.</p>

<h3 id="partitioning">Partitioning</h3>

<p>The server should use LVM for disk space, so instead of the default <em>Guided Partitioning</em>, choose <em>Manual</em>, then <em>SCSI3</em>, then:</p>

<ul>
  <li>Select <em>pri/log free space</em>, <em>Create a new partition</em>, 40 GB, <em>Primary</em>, <em>Beginning</em>, <em>Done</em>.</li>
  <li>Select the new partition, choose <em>Use as &gt; Physical volume for LVM</em>.</li>
  <li>Select <em>Configure LVM volumes</em></li>
  <li>Enter a name for the new main volume group, for example <code>xenvg</code>.</li>
  <li>Create a logical volume of 8 GB, <em>Name &gt; Root, Use as &gt; ext4 filesystem, Mount point &gt; / (root)</em>.</li>
  <li>Create a logical volume of 4 GB, <em>Name &gt; Swap, Use as &gt; swap</em>.</li>
  <li>Leave the rest of the volume group as unallocated free space.</li>
  <li>Finish and Write changes to disk.</li>
</ul>

<h3 id="proxy-server"> Proxy Server</h3>

<p>When asked for a proxy server, enter this one (to save a LONG install time):</p>

<ul>
  <li>http://197.4.11.251:3142</li>
</ul>

<p>Please enter this carefully and check it. Using the wrong value will make it
impossible for you to install any packages.  Of course, if you are not at the
AfNOG workshop then this server will no longer exist, so use a local proxy
server or leave it blank.</p>

<h3 id="network-re-configuration">Network Re-Configuration</h3>

<p>After installation, shut down the machine and reconfigure its network interfaces in VirtualBox</p>

<ul>
  <li>Adapter 1: Do not change, leave set to NAT.</li>
  <li>Adapter 2: Host-only network, vboxnet0, enable Promiscuous Mode.</li>
</ul>

<p><img src="virtualbox-configure-adaptor-2.png" alt="Configuring Network Adaptor 1" /></p>

<p>Then start the machine again. Log in on the console and edit <code>/etc/network/interfaces</code> to look like this:</p>

<pre><code># The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
auto eth0
iface eth0 inet dhcp

auto eth1
iface eth1 inet manual

auto xen-br0
iface xen-br0 inet static
	address 192.168.56.10
	netmask 255.255.255.0
	bridge_ports eth1
	bridge_stp off
	bridge_fd 0
</code></pre>

<p>Edit <code>/etc/hostname</code> and put the fully-qualified hostname (FQDN) in there.</p>

<p>Edit <code>/etc/hosts</code> and ensure that it contains the IP address and hostname of
your host. You will also need to choose a name (hostname) and IP address for
your cluster, which must be different. For example:</p>

<pre><code>127.0.0.1       localhost
192.168.56.10   ganeti1.sse.ws.afnog.org
192.168.56.11   cluster1.sse.ws.afnog.org
</code></pre>

<p>Normally you would add DNS entries for all of these. Feel free to use the DNS
for the cluster name, instead of editing <code>/etc/hosts</code>. Your hostname should
really be in the DNS as well, but for the purposes of this exercise
(non-production deployment) it doesn’t matter too much.</p>

<p>Then <code>reboot</code> the host, log in again and run the following commands:</p>

<pre><code>sudo apt-get dist-upgrade	
sudo apt-get install ganeti2 ganeti-htools ganeti-instance-debootstrap
</code></pre>

<p>Start following the <a href="http://docs.ganeti.org/ganeti/2.13/html/install.html">Ganeti installation tutorial¶</a>,
skipping the following sections:</p>

<ul>
  <li>Anything to do with KVM (we’re using Xen instead)</li>
  <li>Installing RBD: skip to <a href="http://docs.ganeti.org/ganeti/2.13/html/install.html#installing-gluster">Installing Gluster</a> instead.</li>
  <li>KVM userspace access</li>
  <li>Configuring the network</li>
  <li>Configuring LVM</li>
  <li>Installing Ganeti: skip to <a href="#initializing-the-cluster">#Initializing the Cluster</a> below.</li>
  <li>Installing Ganeti: skip to <a href="#initializing-the-cluster">#Initializing the Cluster</a> below.</li>
</ul>

<h3 id="initializing-the-cluster">Initializing the Cluster</h3>

<p>Run the following command, substituting the cluster name you added to
<code>/etc/hosts</code> instead of <code>cluster1...</code>:</p>

<pre><code>sudo gnt-cluster init --vg-name Main --enabled-hypervisors=xen-pvm cluster1.sse.ws.afnog.org
</code></pre>

<p><strong>Note:</strong> Normally you would use either <code>xen-hvm</code> or <code>kvm</code> as the hypervisor,
instead of <code>xen-pvm</code> above. In this case we must use <code>xen-pvm</code> because we are
doing this inside a virtual machine, so we can’t use the virtualisation CPU
instructions because VirtualBox is already using them to run the Ganeti host
node (VirtualBox guest).</p>

<p>Create the file <code>/etc/ganeti/vnc-cluster-password</code> containing the password that
you want to use for VNC access to consoles.</p>

<h3 id="testing-the-setup">Testing the Setup</h3>

<p>Check that the <code>gnt-node list</code> command shows your node:</p>

<pre><code>$ sudo gnt-node list
Node                     DTotal DFree MTotal MNode MFree Pinst Sinst
ganeti1.sse.ws.afnog.org      ?     ?      ?     ?     ?     0     0
</code></pre>

<p>Continue following the installation instructions from <a href="http://docs.ganeti.org/ganeti/2.13/html/install.html#testing-the-setup">Testing the setup</a></p>



<script type="text/javascript">
var converter = new Showdown.converter();
var markdownArea = document.getElementById('markdown');
if (markdownArea)
{
	markdownArea.innerHTML = converter.makeHtml(markdownArea.innerHTML);
}
</script>

<div class="bottomlinks">
<p><a href="../index.html">Return to AfNOG Workshop Main Page</a></p>
</div>

</body>
</html>

